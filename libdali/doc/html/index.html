<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>libdali: libdali: the DataLink client library</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li class="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>libdali: the DataLink client library</h1>
<p>
<h3 align="center">1.0 </h3><h2><a class="anchor" name="Purpose">
Purpose</a></h2>
The purpose of this library is to provide all needed functionality for communicating with a DataLink server in a generalized way. This library facilitates rapid DataLink client development as the client does not need to know any details of the DataLink protocol. The library is written in C.<h2><a class="anchor" name="usage">
The DataLink Connection Parameters</a></h2>
The usage philosophy is that each connection to DataLink server is associated with a DataLink Connection Parameters (<a class="el" href="d9/d9a/struct_d_l_c_p.html">DLCP</a>) descriptor which contains both connection paramters and state information. In libdali the <a class="el" href="d9/d9a/struct_d_l_c_p.html">DLCP</a> is implemented as a C struct which is used by most of the utility functions. The struct is given below with descriptions of each parameter:<p>
<div class="fragment"><pre class="fragment">  <span class="keyword">typedef</span> <span class="keyword">struct </span>DLCP_s
  {
    <span class="keywordtype">char</span>        addr[100];
    <span class="keywordtype">char</span>        clientid[200];
    <span class="keywordtype">int</span>         keepalive;
    <span class="keywordtype">int</span>         iotimeout;
  
    <span class="keywordtype">int</span>         link;
    <span class="keywordtype">float</span>       serverproto;
    int32_t     maxpktsize;
    int8_t      writeperm;
    int64_t     pktid;
    <a class="code" href="d3/d41/libdali_8h.html#d46ecd16ed2b512a60d5f948fa15a31f">dltime_t</a>    pkttime;
    int8_t      keepalive_trig;
    <a class="code" href="d3/d41/libdali_8h.html#d46ecd16ed2b512a60d5f948fa15a31f">dltime_t</a>    keepalive_time;
    int8_t      terminate;
    int8_t      streaming;
  
    <a class="code" href="da/dd8/struct_d_l_log.html">DLLog</a>      *log;
  } <a class="code" href="d9/d9a/struct_d_l_c_p.html">DLCP</a>;
</pre></div><p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>sladdr</em>&nbsp;</td><td>The address of the DataLink server to connect to in 'host:port' format. example: "st27.gfz-potsdam.de:18000". The host or port specifications are both optional, they will default to 'localhost' and '16000' respectively.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>clientid</em>&nbsp;</td><td>Client identification sent to the server during initial handshake. This ID is populated in a call to <a class="el" href="d5/d5f/connection_8c.html#663e07d45c7acd0377b5f1f4d930b5a7" title="Create a new DataLink Connection Parameter (DLCP) structure.">dl_newdlcp()</a>. Normally this takes the form of: "progname:username:pid:arch", for example: "dalitool:rt:6055:SunOS-5.10"</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keepalive</em>&nbsp;</td><td>Interval in seconds to send keepalive packets to the server when no data is being received with either <a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a> or <a class="el" href="d5/d5f/connection_8c.html#a1343fa010d7cce001da5fb4a231dcd7" title="Collect packets streaming from the DataLink server without blocking.">dl_collect_nb()</a>. Default interval is 600 seconds, 0 to disable.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>iotimeout</em>&nbsp;</td><td>Network I/O timeout in seconds. Send and receive operations will be interrupted after this timeout to avoid hung socket connections. Default timeout is 60 seconds, 0 to disable.</td></tr>
  </table>
</dl>
The following parameters are maintained by the library routines and should generally not be set externally.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>link</em>&nbsp;</td><td>This is the file descriptor associated with the connected network socket. This value will be -1 when not connected to a server.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>serverproto</em>&nbsp;</td><td>The DataLink protocol version of the connected server. This is set during connection handshake and will be 0.0 if it was not supplied by the server.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxpktsize</em>&nbsp;</td><td>The maximum packet size supported by the connected server. This is set during connection handshake and will be 0 if it was not supplied by the server.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>writeperm</em>&nbsp;</td><td>A flag indicating if the server has granted the client write permission. This is set during connection handshake and will be 1 if write permission is granted and 0 otherwise.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pktid</em>&nbsp;</td><td>Packet ID of the last packet received. A packet ID is a large integer uniquely identifying a packet in a DataLink server instance.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pkttime</em>&nbsp;</td><td>Packet time of the last packet received. Each DataLink packet has an associated packet creation time which, when combined with the pktid, can be used to uniquely identify a packet in a DataLink server instance.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keepalive_trig</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keepalive_time</em>&nbsp;</td><td>These are used to trigger and track the sending of keep- alive packets.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>terminate</em>&nbsp;</td><td>Used internally to indicate connection termination.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>streaming</em>&nbsp;</td><td>Used to indicate status of streaming mode, set to either true (1) or false (0). Streaming mode is activated when either <a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a> or <a class="el" href="d5/d5f/connection_8c.html#a1343fa010d7cce001da5fb4a231dcd7" title="Collect packets streaming from the DataLink server without blocking.">dl_collect_nb()</a> is initially called, a specific call to those functions will deactivate streaming. When a connection is in streaming mode most server query functions will not work.</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>log</em>&nbsp;</td><td>Logging parameters specific to this connection.</td></tr>
  </table>
</dl>
<h2><a class="anchor" name="config">
Configuring a DataLink connection</a></h2>
There are a number of functions to assist with the creation of a <a class="el" href="d9/d9a/struct_d_l_c_p.html">DLCP</a> struct and the configuration of a connection (see the man pages for programming details):<p>
<a class="el" href="d5/d5f/connection_8c.html#663e07d45c7acd0377b5f1f4d930b5a7" title="Create a new DataLink Connection Parameter (DLCP) structure.">dl_newdlcp()</a> : Allocate and initialize a <a class="el" href="d9/d9a/struct_d_l_c_p.html">DLCP</a> struct with default values.<p>
<a class="el" href="d5/d5f/connection_8c.html#7603e72f54c34879f86c319239a50e52" title="Free a DataLink Connection Parameter (DLCP) structure.">dl_freedlcp()</a> : Free all memory associated with a <a class="el" href="d9/d9a/struct_d_l_c_p.html">DLCP</a> struct.<p>
<a class="el" href="d5/d5f/connection_8c.html#823f483f8492e0317a5221c3f02b13d0" title="Position the client read position.">dl_position()</a> : Position the connection to a specific packet in the DataLink server based on packet ID and packet time.<p>
<a class="el" href="d5/d5f/connection_8c.html#b8bc14b495d971ea3b119bfc3796b00f" title="Position the client read position based on data time.">dl_position_after()</a> : Position the connection to a specific packet in DataLink server based on data time.<p>
<a class="el" href="d5/d5f/connection_8c.html#0a7501ffdf01f73f8e5b1c1b9ca29843" title="Set the packet match parameters for a connection.">dl_match()</a> : Send a new regular expression matching pattern to the DataLink server. Used to limit packets to specific stream IDs for packet transfer or stream listing.<p>
<a class="el" href="d5/d5f/connection_8c.html#ffcdbcae2611a8c6208243bc2a418149" title="Set the packet reject parameters for a connection.">dl_reject()</a> : Send a new regular expression rejecting pattern to the DataLink server, the antithesis of the matching pattern.<h2><a class="anchor" name="basic">
Fundamental read, write and query</a></h2>
<a class="el" href="d5/d5f/connection_8c.html#9a49f3842de1a14030b20e665bfcbf31" title="Request a packet from the DataLink server.">dl_read()</a> : Read a specific packet from a DataLink server.<p>
<a class="el" href="d5/d5f/connection_8c.html#6a21194a1a308eb91db0d32bced621f8" title="Send a packet to the DataLink server.">dl_write()</a> : Write a supplied packet to a DataLink server.<p>
<a class="el" href="d5/d5f/connection_8c.html#812ede0c3d5e15ab118c489087b01260" title="Request information from the DataLink server.">dl_getinfo()</a> : Submit an INFO request to and collect the response from a DataLink server. Responses are in XML. Request types include STATUS, STREAMS and CONNECTIONS.<h2><a class="anchor" name="connmanager">
Using the connection manager</a></h2>
Two primary functions are provided to collect packets from a DataLink server in streaming mode: <a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a> and <a class="el" href="d5/d5f/connection_8c.html#a1343fa010d7cce001da5fb4a231dcd7" title="Collect packets streaming from the DataLink server without blocking.">dl_collect_nb()</a>.<p>
<a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a> : Collect and return a packet each time called. Keepalive packets are sent at the keepalive interval when no packets are being sent from the server. If a connection is not currently configured in streaming mode, the first call to <a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a> will turn this mode on. Designed to run in a tight loop at the heart of a client program this routine blocks until a packet is received.<p>
<a class="el" href="d5/d5f/connection_8c.html#a1343fa010d7cce001da5fb4a231dcd7" title="Collect packets streaming from the DataLink server without blocking.">dl_collect_nb()</a> : This is a non-blocking version of <a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a>, it will always return whether a packet is received or not.<p>
<a class="el" href="d5/d5f/connection_8c.html#a357699d12a48e074de595f30e3565fb" title="Set the terminate parameter of a DataLink connection.">dl_terminate()</a> : Set the terminate flag in the connection parameters. This will cause <a class="el" href="d5/d5f/connection_8c.html#ccca46f231c23fd495bb6d5725e97957" title="Collect packets streaming from the DataLink server.">dl_collect()</a>/dl_collect_nb() to return DLENDED. This is commonly used in a signal handler to smoothly exit from a packet collection loop.<h2><a class="anchor" name="statefiles">
Using state files</a></h2>
The DataLink protocol is made stateful by tracking packet IDs and packet times. The state of a connection can be saved and recovered using state files and the following routines:<p>
<a class="el" href="d3/d41/libdali_8h.html#7e326b372c26d47a072cd6ec112e1852" title="Save a DataLink connection state to a file.">dl_savestate()</a> : Save current packet ID and time to a file.<p>
<a class="el" href="d3/d41/libdali_8h.html#3a993121cf88eeb7d74e007ddd2203ec" title="Recover DataLink connection state from a file.">dl_recoverstate()</a> : Recover packet ID and time from a file.<h2><a class="anchor" name="logging">
Controlling output from the library functions</a></h2>
All of the log and diagnostic messages emitted by the library functions use the same interface. The output from this interface can be controlled. This is useful when the library will be embedded in a larger system with a custom logging facility. See the man page for more details.<p>
<a class="el" href="d3/d41/libdali_8h.html#37eb5ed80e669d3812a2d1f0e23d8500" title="Initialize global logging system parameters.">dl_loginit()</a> : initialize the verbosity level of the library functions, also set the functions and prefixes used for log, diagnostic and error messages.<p>
<a class="el" href="d3/d41/libdali_8h.html#847d1902c12516a8564b617ac6c01ceb" title="Log a message using the global logging parameters.">dl_log()</a> : the central logging facility. Behavior is controlled by the settings specified with <a class="el" href="d3/d41/libdali_8h.html#37eb5ed80e669d3812a2d1f0e23d8500" title="Initialize global logging system parameters.">dl_loginit()</a>.<p>
The default destination for log messages is standard output (stdout), while all diagnostic (including error) messages go to standard error (stderr). Most of the internal messages emmited by the library are considered diagnostic and will, by default, go to standard error.<p>
The default prefix for log and diagnostic messages is nothing. The default prefix for diagnostic error messages is "error: ".<p>
There are reentrant versions of these functions that operation either on the logging parameters in a <a class="el" href="d9/d9a/struct_d_l_c_p.html">DLCP</a> struct or directly on a logging parameter <a class="el" href="da/dd8/struct_d_l_log.html">DLLog</a> struct. They are intended for use in threaded programs or where a complex logging scheme is desired. See the man pages for more details.<h2><a class="anchor" name="threads">
Threaded programming</a></h2>
The library is generally thread-safe on Unix-like platforms as long as each thread manages it's own DataLink Connection Parameters (see below). The one exeception is the handling of network I/O timeouts. On systems where the SO_RCVTIMEO and SO_SNDTIMEO socket options are not supported (e.g. Solaris) an alarm timer is used (see setitimer(2)) which, on most systems, utilizes the SIGALARM signal which can be misdirected to an unexpected thread. In this case it is suggested to disable the libdali timeout (set <a class="el" href="d9/d9a/struct_d_l_c_p.html#7a91aad2b1d0ecb361e5115ad62b899d">DLCP.iotimeout</a> = 0) and implement another timeout mechanism if desired. The library is definitely not thread-safe under Win32.<h2><a class="anchor" name="example">
Programming example</a></h2>
See the example DataLink client included with the library in the "example" directory. </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Sep 12 15:38:52 2008 for libdali by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
